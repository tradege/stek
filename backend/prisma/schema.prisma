// StakePro - Crypto Casino Database Schema
// Prisma Schema for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER HIERARCHY (MLM/Agent System)
// 5-Level Structure: Admin → Super Master → Master → Agent → User
// ============================================

enum UserRole {
  ADMIN         // Full system control
  SUPER_MASTER  // Country/Region manager with credit lines
  MASTER        // Group manager
  AGENT         // Direct player manager
  USER          // The player
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
  PENDING_APPROVAL
}


model SiteConfiguration {
  id                String   @id @default(cuid())
  brandName         String
  domain            String   @unique
  logoUrl           String?
  faviconUrl        String?
  primaryColor      String   @default("#00F0FF")
  secondaryColor    String   @default("#0A0E17")
  accentColor       String   @default("#00F0FF")
  backgroundColor   String   @default("#0A0E17")
  cardColor         String   @default("#131B2C")
  dangerColor       String   @default("#FF4757")
  heroImageUrl      String?
  backgroundImageUrl String?
  loginBgUrl        String?
  gameAssets        Json?
  houseEdgeConfig   Json?
  locale            String   @default("en")
  jurisdiction      String?
  licenseType       String?
  adminUserId       String?
  active            Boolean  @default(true)
  isPlatform        Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  affiliateConfig   Json?

  // Relations
  users             User[]
  wallets           Wallet[]
  transactions      Transaction[]
  bets              Bet[]
  chatMessages      ChatMessage[]
  commissions       Commission[]
  botConfig         BotConfig[]
  promotions        Promotion[]

}

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  username          String      @unique
  passwordHash      String
  role              UserRole    @default(USER)
  status            UserStatus  @default(ACTIVE)
  
  // Hierarchy - Recursive relationship
  parentId          String?
  parent            User?       @relation("UserHierarchy", fields: [parentId], references: [id])
  children          User[]      @relation("UserHierarchy")
  
  // Hierarchy level (0 = Admin, 1 = Super Master, etc.)
  hierarchyLevel    Int         @default(4)
  hierarchyPath     String      @default("") // e.g., "/admin-id/super-id/master-id/agent-id/"
  
  // Commission settings
  revenueSharePercent   Decimal   @default(0) @db.Decimal(5, 2)  // % of house edge
  turnoverRebatePercent Decimal   @default(0) @db.Decimal(5, 2)  // % of total bets
  
  // Credit line (for Super Masters and Masters)
  creditLimit       Decimal     @default(0) @db.Decimal(18, 8)
  creditUsed        Decimal     @default(0) @db.Decimal(18, 8)
  
  // Profile
  displayName       String?
  avatarUrl         String?
  country           String?
  language          String      @default("en")
  timezone          String      @default("UTC")
  
  // Security
  twoFactorEnabled  Boolean     @default(false)
  twoFactorSecret   String?
 // Token versioning for zombie token protection
  tokenVersion      Int         @default(0)
  emailVerificationToken String?
  affiliateCarryover Decimal    @default(0) @db.Decimal(18, 8)
  
  // Bot flag - for separating real users from simulated bots
  isBot             Boolean     @default(false)
  lastLoginAt       DateTime?
  lastLoginIp       String?
  
  // VIP System
  vipLevel          Int         @default(0)  // 0-10 VIP levels
  totalWagered      Decimal     @default(0) @db.Decimal(18, 8)  // Total amount wagered for VIP
  xp                Int         @default(0)  // Experience points for gamification
  totalBets         Int         @default(0)  // Total number of bets
  claimableRakeback Decimal     @default(0) @db.Decimal(18, 8)  // Accumulated rakeback
  
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  wallets           Wallet[]
  bets              Bet[]
  transactions      Transaction[]
  commissionsEarned Commission[]  @relation("CommissionRecipient")
  commissionsGenerated Commission[] @relation("CommissionSource")
  sentTips          Tip[]       @relation("TipSender")
  receivedTips      Tip[]       @relation("TipReceiver")
  vaultDeposits     VaultDeposit[]
  sessions          UserSession[]
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  gameSessions      GameSession[] @relation("GameSessions")
  chatMessages      ChatMessage[] @relation("UserChatMessages")
  statistics        Statistic[]   @relation("UserStatistics")
  rewardHistory     RewardHistory[]
  rewardContributions RewardPoolContribution[]
  
  @@index([parentId])
  @@index([role])
  @@index([status])
  @@index([hierarchyPath])
  @@index([email])
  @@index([username])
  siteId            String?
  site              SiteConfiguration? @relation(fields: [siteId], references: [id])


  jackpotWins        JackpotWin[]
  // Relations for new models
  sportBets      SportBet[]
  supportTickets SupportTicket[]
  fraudAlerts    FraudAlert[]
}

model UserSession {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token         String    @unique
  ipAddress     String
  userAgent     String?
  expiresAt     DateTime
  createdAt     DateTime  @default(now())
  
  @@index([userId])
  @@index([token])
}

// ============================================
// FINANCIAL ENGINE (Multi-Currency Wallets)
// ============================================

enum Currency {
  BTC
  ETH
  USDT
  SOL
  // Add more as needed
}

model Wallet {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  currency        Currency
  
  // Balances (using Redis for real-time, this is for persistence)
  balance         Decimal     @default(0) @db.Decimal(18, 8)
  lockedBalance   Decimal     @default(0) @db.Decimal(18, 8)  // For pending bets
  bonusBalance    Decimal     @default(0) @db.Decimal(18, 8)  // Non-withdrawable bonus funds
  
  // Deposit address
  depositAddress  String?     @unique
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  transactions    Transaction[]
  
  @@unique([userId, currency])
  @@index([userId])
  @@index([currency])
  siteId            String?
  site              SiteConfiguration? @relation(fields: [siteId], references: [id])

}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  BET
  WIN
  COMMISSION
  TIP_SENT
  TIP_RECEIVED
  VAULT_DEPOSIT
  VAULT_WITHDRAWAL
  RAIN_RECEIVED
  CREDIT_GIVEN
  CREDIT_REPAID
  RAKEBACK
  BONUS
  TRIVIA
  RACE_PRIZE
  WEEKLY_BONUS
  MONTHLY_BONUS
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}

model Transaction {
  id              String            @id @default(uuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  walletId        String
  wallet          Wallet            @relation(fields: [walletId], references: [id])
  
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  
  amount          Decimal           @db.Decimal(18, 8)
  balanceBefore   Decimal           @db.Decimal(18, 8)
  balanceAfter    Decimal           @db.Decimal(18, 8)
  
  // External reference (blockchain tx, bet id, etc.)
  externalRef     String?
  
  // Metadata
  metadata        Json?
  
  // Bot flag - transactions from bot users
  isBot           Boolean       @default(false)
  
  // Timestamps
  createdAt       DateTime          @default(now())
  confirmedAt     DateTime?
  
  @@index([userId])
  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  siteId            String?
  site              SiteConfiguration? @relation(fields: [siteId], references: [id])

}

// ============================================
// VAULT (Savings Feature)
// ============================================

model VaultDeposit {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  currency        Currency
  
  amount          Decimal     @db.Decimal(18, 8)
  interestRate    Decimal     @default(0) @db.Decimal(5, 4)  // APY
  
  depositedAt     DateTime    @default(now())
  withdrawnAt     DateTime?
  
  @@index([userId])
  @@index([currency])
}

// ============================================
// TIPPING (P2P Transfers)
// ============================================

model Tip {
  id              String      @id @default(uuid())
  senderId        String
  sender          User        @relation("TipSender", fields: [senderId], references: [id])
  receiverId      String
  receiver        User        @relation("TipReceiver", fields: [receiverId], references: [id])
  
  currency        Currency
  amount          Decimal     @db.Decimal(18, 8)
  message         String?
  
  createdAt       DateTime    @default(now())
  
  @@index([senderId])
  @@index([receiverId])
}

// ============================================
// RAIN (Chat Bonuses)
// ============================================

model Rain {
  id              String      @id @default(uuid())
  creatorId       String
  currency        Currency
  totalAmount     Decimal     @db.Decimal(18, 8)
  amountPerUser   Decimal     @db.Decimal(18, 8)
  maxParticipants Int
  
  participants    RainParticipant[]
  
  expiresAt       DateTime
  createdAt       DateTime    @default(now())
  
  @@index([creatorId])
}

model RainParticipant {
  id              String      @id @default(uuid())
  rainId          String
  rain            Rain        @relation(fields: [rainId], references: [id])
  userId          String
  
  claimedAt       DateTime    @default(now())
  
  @@unique([rainId, userId])
  @@index([rainId])
  @@index([userId])
}

// ============================================
// COMMISSION SYSTEM (Dynamic Distribution)
// ============================================

model Commission {
  id              String      @id @default(uuid())
  
  // Who earned the commission
  recipientId     String
  recipient       User        @relation("CommissionRecipient", fields: [recipientId], references: [id])
  
  // Who generated the commission (the player who bet)
  sourceUserId    String
  sourceUser      User        @relation("CommissionSource", fields: [sourceUserId], references: [id])
  
  // Related bet
  betId           String
  bet             Bet         @relation(fields: [betId], references: [id])
  
  // Commission details
  currency        Currency
  amount          Decimal     @db.Decimal(18, 8)
  
  // Type of commission
  commissionType  CommissionType
  
  // Hierarchy level of recipient (1 = direct parent, 2 = grandparent, etc.)
  levelFromSource Int
  
  createdAt       DateTime    @default(now())
  
  @@index([recipientId])
  @@index([sourceUserId])
  @@index([betId])
  @@index([createdAt])
  siteId            String?
  site              SiteConfiguration? @relation(fields: [siteId], references: [id])

}

enum CommissionType {
  REVENUE_SHARE     // % of house edge
  TURNOVER_REBATE   // % of total bet amount
}

// ============================================
// GAME INTEGRITY (Provably Fair)
// ============================================

model Bet {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  
  gameType        GameType
  currency        Currency
  
  // Bet details
  betAmount       Decimal     @db.Decimal(18, 8)
  multiplier      Decimal     @db.Decimal(10, 4)
  payout          Decimal     @db.Decimal(18, 8)
  profit          Decimal     @db.Decimal(18, 8)  // Can be negative (loss)
  
  // Provably Fair
  serverSeed      String
  serverSeedHash  String      // SHA256 of serverSeed (shown before bet)
  clientSeed      String
  nonce           Int
  
  // Game-specific data
  gameData        Json?       // Stores game-specific info (crash point, mines positions, etc.)
  
  // Status
  isWin           Boolean
  
  // Timestamps
  createdAt       DateTime    @default(now())
  settledAt       DateTime?
  
  // Relations
  commissions     Commission[]
  
  @@index([userId])
  @@index([gameType])
  @@index([createdAt])
  @@index([isWin])
  siteId            String?
  site              SiteConfiguration? @relation(fields: [siteId], references: [id])

}

enum GameType {
  CRASH
  PLINKO
  MINES
  DICE
  LIMBO
  KENO
  WHEEL
  BLACKJACK
  ROULETTE
  BACCARAT
  OLYMPUS
  DRAGON_BLAZE
  NOVA_RUSH
  CARD_RUSH
  PENALTY_SHOOTOUT
  SPORTS
  SLOTS_BONANZA
  SLOTS_BOOK
  SLOTS_STARBURST
  SLOTS_BASS
  EXTERNAL  // For external provider games
}

// ============================================
// SERVER SEEDS (For Provably Fair rotation)
// ============================================

model ServerSeed {
  id              String      @id @default(uuid())
  userId          String
  
  seed            String
  seedHash        String      // SHA256(seed)
  
  isActive        Boolean     @default(true)
  nonce           Int         @default(0)
  
  revealedAt      DateTime?
  createdAt       DateTime    @default(now())
  
  @@index([userId])
  @@index([isActive])
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model SystemConfig {
  id              String      @id @default(uuid())
  key             String      @unique
  value           Json
  description     String?
  
  updatedAt       DateTime    @updatedAt
  createdAt       DateTime    @default(now())
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id              String      @id @default(uuid())
  userId          String?
  action          String
  entityType      String
  entityId        String?
  adminId         String?
  targetId        String?
  details         Json?
  
  oldData         Json?
  newData         Json?
  
  ipAddress       String?
  userAgent       String?
  siteId          String?
  
  createdAt       DateTime    @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

// ============================================
// EXTERNAL GAME AGGREGATOR SYSTEM
// ============================================

// --- ENUMS ---
enum GameCategory {
  SLOTS
  LIVE_CASINO
  CRASH
  SPORTS
  TABLE_GAMES
  ORIGINALS
  VIRTUAL_SPORTS
}

enum Volatility {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  ERROR
}

// --- MODELS ---

// Game Provider (e.g., Pragmatic Play, Evolution, etc.)
model GameProvider {
  id              String      @id @default(uuid())
  name            String      @unique
  slug            String      @unique  // e.g., "pragmatic"
  aggregatorId    String?     // ID on aggregator platform (if using aggregator)
  aggregatorName  String?     // Name of aggregator (e.g., "SoftSwiss", "SoftGamings")
  apiUrl          String?
  apiKey          String?
  apiSecret       String?
  isActive        Boolean     @default(true)
  isLive          Boolean     @default(false)  // Live casino provider
  feePercentage   Float       @default(0)  // Provider fee percentage (e.g., 8 = 8% of GGR)
  ipWhitelist     String[]    // Array of allowed IPs for callbacks
  config          Json?       // Provider specific settings
  
  games           Game[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([slug])
  @@index([isActive])
}

// Game Catalog
model Game {
  id              String        @id @default(uuid())
  providerId      String
  provider        GameProvider  @relation(fields: [providerId], references: [id])
  
  externalId      String        // ID on provider side
  name            String
  slug            String        @unique
  category        GameCategory
  subcategory     String?       // e.g., "Video Slots", "Classic Slots", "Megaways"
  tags            String[]      @default([])  // For search and filtering
  
  // Metadata
  thumbnail       String?
  banner          String?
  description     String?
  rtp             Decimal?      @db.Decimal(5, 2)  // Return to Player %
  volatility      Volatility?
  minBet          Decimal?      @db.Decimal(18, 8)
  maxBet          Decimal?      @db.Decimal(18, 8)
  
  // Statistics
  playCount       Int           @default(0)  // Number of times played
  
  // Flags
  isActive        Boolean       @default(true)
  isNew           Boolean       @default(false)
  isHot           Boolean       @default(false)
  isFeatured      Boolean       @default(false)
  sortOrder       Int           @default(0)
  
  sessions        GameSession[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([providerId, externalId])
  @@index([category])
  @@index([isActive])
  @@index([sortOrder])
  @@index([slug])
}

// Game Session (for tracking external game rounds)
model GameSession {
  id                  String        @id @default(uuid())
  userId              String
  user                User          @relation("GameSessions", fields: [userId], references: [id])
  gameId              String
  game                Game          @relation(fields: [gameId], references: [id])
  
  externalSessionId   String?       @unique
  currency            String        @default("USDT")
  status              SessionStatus @default(ACTIVE)
  
  totalBet            Decimal       @default(0) @db.Decimal(18, 8)
  totalWin            Decimal       @default(0) @db.Decimal(18, 8)
  
  startedAt           DateTime      @default(now())
  endedAt             DateTime?
  
  @@index([userId])
  @@index([gameId])
  @@index([status])
}

// ============================================
// CHAT SYSTEM
// ============================================

model ChatMessage {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation("UserChatMessages", fields: [userId], references: [id], onDelete: Cascade)
  
  message     String
  isSystem    Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  
  @@index([userId])
  @@index([createdAt])
  siteId            String?
  site              SiteConfiguration? @relation(fields: [siteId], references: [id])

}

// ============================================
// STATISTICS SYSTEM
// ============================================

enum StatisticType {
  TOTAL_WAGERED
  TOTAL_WON
  TOTAL_LOST
  GAMES_PLAYED
  WIN_RATE
  BIGGEST_WIN
  BIGGEST_LOSS
  PROFIT_LOSS
}

model Statistic {
  id          String        @id @default(uuid())
  userId      String
  user        User          @relation("UserStatistics", fields: [userId], references: [id], onDelete: Cascade)
  
  type        StatisticType
  value       Decimal       @db.Decimal(18, 8)
  gameType    String?       // e.g., "crash", "plinko", "slots"
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@unique([userId, type, gameType])
  @@index([userId])
  @@index([type])
}

// ============================================
// REWARD POOL SYSTEM
// ============================================

model RewardPool {
  id                      String    @id @default(uuid())
  totalAccumulated        Decimal   @default(0) @db.Decimal(18, 8)
  totalDistributed        Decimal   @default(0) @db.Decimal(18, 8)
  currentBalance          Decimal   @default(0) @db.Decimal(18, 8)
  lastWeeklyDistribution  DateTime?
  lastMonthlyDistribution DateTime?
  siteId                  String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  @@index([siteId])
}

model RewardHistory {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String    // RAKEBACK, WEEKLY_BONUS, MONTHLY_BONUS, VIP_LEVELUP, MANUAL_BONUS
  amount          Decimal   @db.Decimal(18, 8)
  source          String    // e.g., "Reward Pool", "VIP System", "Admin"
  description     String?
  metadata        Json?
  isWithdrawable  Boolean   @default(false)
  siteId          String?
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model RewardPoolContribution {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  betId       String?
  amount      Decimal   @db.Decimal(18, 8)
  gameType    String
  siteId      String?
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([createdAt])
}

model BotConfig {
  id                 String   @id @default(cuid())
  siteId             String
  site               SiteConfiguration @relation(fields: [siteId], references: [id])
  enabled            Boolean  @default(false)
  botCount           Int      @default(50)
  minBetAmount       Decimal  @default(0.10)
  maxBetAmount       Decimal  @default(100.00)
  chatEnabled        Boolean  @default(true)
  chatIntervalMin    Int      @default(5)
  chatIntervalMax    Int      @default(30)
  botNamePrefix      String   @default("Player")
  customChatMessages String[]
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([siteId])
}


model Promotion {
  id          String    @id @default(cuid())
  title       String
  description String
  type        String
  bonusPercent Int      @default(0)
  maxBonus    Decimal   @default(0)
  wagerReq    Int       @default(1)
  minDeposit  Decimal   @default(0)
  currency    String    @default("USD")
  imageUrl    String?
  active      Boolean   @default(true)
  startsAt    DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  siteId      String?
  site        SiteConfiguration? @relation(fields: [siteId], references: [id])
}


// ============================================
// SPORTS BETTING MODELS
// ============================================
model SportEvent {
  id            String   @id @default(cuid())
  externalId    String   @unique
  sportKey      String
  sportTitle    String?
  leagueTitle   String?
  homeTeam      String
  awayTeam      String
  commenceTime  DateTime
  status        String   @default("UPCOMING") // UPCOMING, LIVE, COMPLETED, CANCELLED
  homeScore     Int?
  awayScore     Int?
  result        String?  // home, away, draw
  siteId        String?
  markets       SportMarket[]
  bets          SportBet[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SportMarket {
  id            String   @id @default(cuid())
  eventId       String
  event         SportEvent @relation(fields: [eventId], references: [id])
  marketType    String   // h2h, spreads, totals
  bookmaker     String?
  outcomes      Json     // [{name, price}]
  lastUpdate    DateTime @default(now())
  lastUpdated   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  @@unique([eventId, marketType])
}

model SportBet {
  id            String   @id @default(cuid())
  userId        String
  user          User    @relation(fields: [userId], references: [id])
  eventId       String
  event         SportEvent @relation(fields: [eventId], references: [id])
  marketType    String
  selection     String
  odds          Float
  amount        Decimal  @db.Decimal(18, 2)
  potentialWin  Decimal  @db.Decimal(18, 2)
  payout        Decimal  @default(0) @db.Decimal(18, 2)
  status        String   @default("PENDING") // PENDING, WON, LOST, VOID, CASHOUT
  siteId        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// SUPPORT MODELS
// ============================================
model SupportTicket {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  name          String?
  email         String?
  subject       String
  message       String
  status        String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  priority      String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  category      String?
  siteId        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// FRAUD DETECTION MODELS
// ============================================
model FraudAlert {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  type          String   // MULTI_ACCOUNT, BONUS_ABUSE, UNUSUAL_PATTERN, etc
  severity      String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  status        String   @default("OPEN") // OPEN, REVIEWED, RESOLVED, DISMISSED
  description   String
  metadata      Json?
  resolved      Boolean  @default(false)
  resolvedBy    String?
  resolvedAt    DateTime?
  siteId        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// RISK MANAGEMENT MODELS
// ============================================
model RiskLimit {
  id                String   @id @default(cuid())
  siteId            String   @unique
  maxBetAmount      Decimal  @default(1000) @db.Decimal(18, 2)
  maxWinAmount      Decimal  @default(10000) @db.Decimal(18, 2)
  maxDailyDeposit   Decimal  @default(50000) @db.Decimal(18, 2)
  maxDailyWithdraw  Decimal  @default(25000) @db.Decimal(18, 2)
  maxExposure       Decimal  @default(100000) @db.Decimal(18, 2)
  active            Boolean  @default(true)
  maxPayoutPerBet   Decimal  @default(10000) @db.Decimal(18, 2)
  maxPayoutPerDay   Decimal  @default(50000) @db.Decimal(18, 2)
  dailyPayoutUsed   Decimal  @default(0) @db.Decimal(18, 2)
  lastResetDate     DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// BET ALERT MODEL (for sports bet validation)
// ============================================
model BetAlert {
  id            String   @id @default(cuid())
  betId         String?
  userId        String?
  type          String
  severity      String   @default("MEDIUM")
  description   String
  metadata      Json?
  resolved      Boolean  @default(false)
  createdAt     DateTime @default(now())
}

model RewardPoolSettings {
  id                      String    @id @default(uuid())
  
  // Master toggles
  weeklyBonusEnabled      Boolean   @default(true)
  monthlyBonusEnabled     Boolean   @default(true)
  
  // Pool contribution rate (% of house edge that goes to pool)
  poolContributionRate    Decimal   @default(0.05) @db.Decimal(10, 4)   // 5%
  
  // Distribution split (weekly vs monthly)
  weeklyPoolPercent       Decimal   @default(0.60) @db.Decimal(10, 4)   // 60%
  monthlyPoolPercent      Decimal   @default(0.40) @db.Decimal(10, 4)   // 40%
  
  // Top 3 player split
  firstPlacePercent       Decimal   @default(0.50) @db.Decimal(10, 4)   // 50%
  secondPlacePercent      Decimal   @default(0.30) @db.Decimal(10, 4)   // 30%
  thirdPlacePercent       Decimal   @default(0.20) @db.Decimal(10, 4)   // 20%
  
  // Pool caps
  weeklyPoolCap           Decimal   @default(500) @db.Decimal(18, 2)    // $500
  monthlyPoolCap          Decimal   @default(2000) @db.Decimal(18, 2)   // $2000
  
  // Min wagering to qualify
  minWageringForBonus     Decimal   @default(10) @db.Decimal(18, 2)     // $10
  
  // Cooldown between distributions (hours)
  weeklyCooldownHours     Int       @default(144)                       // 6 days
  monthlyCooldownHours    Int       @default(648)                       // 27 days
  
  // Number of top players to reward
  topPlayersCount         Int       @default(3)
  
  siteId                  String?   @unique
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  @@index([siteId])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([token])
}

// ============================================
// THE VAULT - Global Progressive Jackpot
// ============================================
model JackpotPool {
  id              String   @id @default(uuid())
  name            String   @default("The Vault")
  currentAmount   Decimal  @default(0) @db.Decimal(18, 2)
  seedAmount      Decimal  @default(100) @db.Decimal(18, 2)  // Minimum starting amount
  contributionRate Decimal @default(0.001) @db.Decimal(8, 6)  // 0.1% of each bet
  dropThreshold   Int      @default(1000000)  // Hash % dropThreshold == 777
  isActive        Boolean  @default(true)
  lastWonAt       DateTime?
  lastWonBy       String?
  lastWonAmount   Decimal? @db.Decimal(18, 2)
  totalPaidOut    Decimal  @default(0) @db.Decimal(18, 2)
  totalContributed Decimal @default(0) @db.Decimal(18, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  wins            JackpotWin[]
  contributions   JackpotContribution[]
}

model JackpotWin {
  id          String   @id @default(uuid())
  poolId      String
  userId      String
  amount      Decimal  @db.Decimal(18, 2)
  gameType    String   // Which game triggered the win
  betId       String?  // Reference to the bet that triggered it
  hash        String   // The winning hash for verification
  createdAt   DateTime @default(now())
  pool        JackpotPool @relation(fields: [poolId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
  @@index([userId])
  @@index([poolId])
}

model JackpotContribution {
  id          String   @id @default(uuid())
  poolId      String
  userId      String
  betAmount   Decimal  @db.Decimal(18, 2)
  contribution Decimal @db.Decimal(18, 6)
  gameType    String
  createdAt   DateTime @default(now())
  pool        JackpotPool @relation(fields: [poolId], references: [id])
  @@index([poolId])
  @@index([userId])
  @@index([createdAt])
}
